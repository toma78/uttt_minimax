#include <stdio.h>
#include <inttypes.h>
#include "position.h"

int mbi2imove(unsigned int mbi, unsigned int bi) {
    unsigned int mbx = mbi%3; unsigned int mby = mbi/3;
    unsigned int bix = bi%3; unsigned int biy = bi/3;
    return 27*mby + 9*biy + 3*mbx + bix;
}

void imove2mbi(unsigned int i, unsigned int *mbi, unsigned int *bi) {
    unsigned int x = i%9; unsigned int y = i/9;
    unsigned int mbx = x/3; unsigned int mby = y/3;
    unsigned int bix = x - 3*mbx; int biy = y - 3*mby;
    *mbi = mby*3 + mbx;
    *bi = 3*biy + bix ;
}

const uint64_t p1hcodes[9][9] = {{659817340411677106L, 1162127621986395220L, 7091966159445791115L, 652423611741815007L, 396125675076335217L, 6491173372301541385L, 3612099343409539622L, 6279027070245938347L, 4513497914708378752L}, {6132590677972341884L, 2790978694798076853L, 2622392466848608007L, 2562925487177907951L, 1181024562170563558L, 8057473471598342606L, 2100083994144316767L, 3199014768247660673L, 6741091009257648391L}, {341260387650223515L, 7055491914601305765L, 4347637911562511944L, 5338749448836635245L, 149452614097380796L, 279628547019306303L, 6293002248962996091L, 7747381543059345420L, 8426014707383222480L}, {7234849450734161537L, 1897728702553435279L, 4862037021913072474L, 5545450163543174852L, 4171275655041853223L, 8410014887309570026L, 1077598685219485601L, 9121157651767209793L, 4654820224427403518L}, {7436138172104994567L, 5109832415229827713L, 8679439038447148890L, 4088023172153378433L, 2412608824408270144L, 7271223356354940443L, 1781937872894122581L, 8440482854050565370L, 1638959577915064094L}, {3700430240984000350L, 2669073210864042571L, 271880562115934325L, 1914078734148914920L, 3159428473663336551L, 2101638508588523868L, 3760062711920209481L, 6604181236616514468L, 2743421118614987771L}, {1161571441237101874L, 6583250877538180459L, 7226382807910308983L, 5748079626221130642L, 4076369835471539547L, 7010754476057688138L, 9126724444516310052L, 2800065072806915110L, 2053425925253816302L}, {8910455994978450760L, 4376108870661963565L, 3603633425330098424L, 6808975134254026585L, 4109393295384841114L, 1742485795093312763L, 3424809287453002482L, 1807279573435083105L, 1502050694016329659L}, {4579313314825938876L, 4732267846166974899L, 8221061259904460643L, 5208095034007814092L, 5227558939597191553L, 214202678609248244L, 3291321064349889133L, 413472122918098340L, 2937727749532946510L}};
const uint64_t p2hcodes[9][9] = {{2593308577593590392L, 6364614768038421232L, 789267580262887045L, 5810351200359409301L, 7078548961448238340L, 8107038190995593558L, 5569244074110255751L, 892113223775284473L, 1766454324780163772L}, {5342910874597568990L, 1844904885376668622L, 9103571200464867008L, 6483051081685763450L, 6430289577306868050L, 7976612270508100196L, 6183369356329703090L, 8676155958572769767L, 1160362611103363418L}, {5633313670131221218L, 3961500684751959260L, 6459774107291414238L, 2784047707213557411L, 719145208423704539L, 3202029945477309085L, 8440190682740581313L, 6274939909488604634L, 6719628146484844453L}, {5890836431772274885L, 8517124738896974038L, 3177604647609427510L, 5198322749824740388L, 8280036416702305090L, 8457246041371181595L, 139396389793148196L, 6063273249563394572L, 2531045541300429144L}, {4889017274029557857L, 5924274366221710298L, 576663559635509079L, 2289538420292173275L, 4483421660066043545L, 8878345363677373077L, 1732776538946269035L, 3701687937068498573L, 3939885669700961072L}, {4135222592463151183L, 4641275260909510322L, 1478014822074837524L, 6171418454425594285L, 1877029984671981952L, 8635481323031854262L, 7662718002666540207L, 2174571540065095499L, 8999870015828039L}, {1907624979319659631L, 8303114909931599020L, 7065072773986325241L, 5551045824044530440L, 2136338537234231066L, 3001175079934893210L, 289906687421377907L, 853994967307915420L, 6190325583247977059L}, {7269339536284048289L, 6839147239057839881L, 1017708428604809640L, 325524757444228116L, 3976856236873404513L, 4381277023940906628L, 5726676216091492867L, 3827161071545497276L, 7442418435914576445L}, {5919959953858928885L, 7866013883239476590L, 5860911773729052882L, 9073791495377489099L, 2149916338996438331L, 3229718476083912146L, 3920915858605330204L, 7108316691955494780L, 3937763577108227210L}};
const uint64_t vbhcodes[512] = {2488945458291360353L,6924386983454853874L,6650708065910999597L,4481760100263414469L,4933325062106205044L,67698764957763763L,7234856188109275901L,2150624033015088852L,2391837495429384473L,4991217847678353827L,5401297589399142731L,3652211810093059511L,7294606090493380976L,411010655211243392L,5748842524091567326L,533492159702650641L,13548287730536164L,1018253908623966842L,1442682687857576661L,1562100579483337625L,2155611321659312870L,7825410519526033867L,7582664900962766728L,2712942602133982457L,6492690698438003603L,3202058541770884043L,8910328654764786040L,7279057591085450588L,2283428881854318359L,2996740023566749559L,8657505350337187237L,3308313364019760083L,2666601038806077411L,7874256267703042950L,449482776162222193L,5931199832868798804L,2478316124913224773L,1690838538587885431L,1652519155683053412L,4215511875563767126L,989947605186068827L,2289345530414646714L,5402291723364353022L,2469727370999515099L,6709028961900381598L,5684907112633025122L,1130961244358592007L,2439912576036585660L,486027437038915084L,8166830198421277162L,4505982280327187098L,3147950130626776765L,9010408419346697220L,3066831145764733344L,4247079137703380291L,3261285791731958443L,5384381857821574901L,4815920472559536380L,3981716901619712201L,3276751765317632745L,7106442806058960224L,5731835758784103473L,2706293317529125280L,4470631380517274075L,1607798967521921155L,305453406121181701L,7255305424065937700L,3168930866590928444L,6187593234579147320L,7723296215307864240L,1107693237376928698L,6590523647231610734L,8897537444267377821L,1009371559088966426L,84490792437498334L,684143538578017045L,3217964528716498662L,5215585938842863069L,3202925858144799452L,4561466472217594149L,7405504000245583667L,1506170921344977970L,1154305686511767534L,613016854097251001L,4843794488020911009L,4662167883980883899L,585014103930523616L,6632243531638918284L,5671778593796540241L,1801376079558034558L,5364705647956084891L,4958734798055162631L,2314305526491662440L,1035552721347561494L,3166765273757337674L,2135915820690327542L,7969042447315848982L,4367411133381429284L,6605811136906674333L,7206256554824452763L,6451302963610665390L,8300327782262131862L,6100499339586129385L,2003247000996236393L,5139977203247825531L,1321887453205252895L,5711077361614474001L,8606750617010979325L,7236620705997408376L,1456260287041326389L,6924778207633360206L,3035117429537719698L,7797740714793258967L,718235968966248638L,5423959098069434422L,6214087643405110093L,912274678850471116L,3387774577566499570L,4730391736824646697L,155398866696554587L,3622780664718772407L,5232312547725954536L,6288208381391881068L,9221820338688969142L,1173969261892290278L,7921910478599308612L,1041733728569082332L,7626773119610011869L,5179202615676125901L,109255115434508491L,3652126145603717153L,4542098769539844549L,2324200217475039768L,4127021231326513919L,7490498295044587995L,8904614195980420621L,3676690899741393411L,533710630979718135L,44147764736970412L,5523619361058800952L,8221600341187317325L,2567897044265225272L,5789925564582806844L,1776567621531682983L,6276136522297656694L,7648954968782422245L,518536210109582409L,4980123979138875978L,6568819691901570023L,7120692670015750515L,2149188704008097490L,2028185217204634185L,1637603591405981325L,4141067845169400851L,909075773730408183L,5025080407081962117L,3954081944762862433L,3782846169583470313L,6470914424474518807L,3817900177367975430L,4374241154089504627L,1761169044247233691L,4072751929642926258L,2649887442844995161L,5318776102682247569L,8692097052892483570L,6155842609697213869L,6875718658888977854L,3635077322136113001L,5306264323329442838L,576025185999210404L,1248493313685865330L,840530524218805172L,79586834794824708L,4280239125016628100L,450357464320199667L,4922145902752648528L,4067511169568424869L,5119129285119591356L,1404010997737082091L,8873792944415590839L,1874261011343100676L,965013816574887767L,3219558304833424555L,5685841980841217939L,294740321194952213L,936193872820192932L,1991417040927998891L,5692724114989140190L,8748433803576758099L,1212183797527430287L,5795873561070160336L,8253034336369525678L,6972705453440781272L,1599758159220130754L,3620119128621665515L,7216908694747693536L,6980168317628467486L,1456687090698109390L,1489066768609593173L,2766344269535660506L,8808165360559932062L,5591937823145609082L,8385413971018859479L,1194751336592131276L,2377376305590060503L,3184278764574425616L,6843885434197919840L,6865399914009217562L,5425950470819170227L,4356189733189798770L,8375116016924184025L,7913780839340067625L,7290922857853700320L,6682997041836409477L,3174702211249555591L,5517651463684901505L,6135587095987834791L,160325097026637763L,8150308410614435497L,3898723860737183603L,7057223858123588990L,3001689001478013127L,6745605811354288399L,6314248019530891477L,4209601444069393995L,8961135220773571457L,5752049788870803529L,9115483137791246748L,2939658592885293172L,2048279414628237380L,3809954407029621327L,1001520034298940457L,4121883503139900101L,1108740067802433457L,4368303243128619509L,2767049306145443448L,6321370273395197575L,200786777699338961L,2639328073173978863L,4208528996206199337L,4633758171706179837L,913327028799947279L,7351441708610110149L,5867100059923464588L,3660877424155905236L,5893865208452761801L,6314974423778479697L,1098388507800325530L,3361147653050877793L,2919311731330730002L,2851283944821706036L,8119650336988221273L,9097331180288755918L,21022328203923093L,4843913791347052363L,4903225359952399217L,4388742056553434307L,1218790779705313630L,992804982829301768L,6805326368889784039L,7805001769933556207L,8377738321842490258L,752070219303767128L,7242048217703663966L,474110768029125932L,3795374049844936802L,5124800044730437049L,1309180761575804244L,1535528751282605119L,5981385803316284292L,8412966182677464343L,8676387856587047807L,9081811179946397010L,3294781484101289235L,7886924441986811754L,1575023592148255846L,3972144751131904834L,8678211614377724386L,114540631929078188L,2612820975822783479L,2823203366500191423L,5312229970216177277L,5345584708827107133L,4516022977380108586L,2705503882183197904L,2226746499830337324L,919691884671420527L,7593683005012921679L,6589349536173868252L,2763698830698760297L,7351473317255597301L,8699039306961928445L,5049664666986432335L,2263648807403603088L,8620295560414381215L,8295122013003727696L,7428828754681414254L,3905754691466707088L,7002018442051078102L,2188439638791638093L,1545649146571866179L,7104799807958697745L,4442603775648942180L,2573847753778874215L,2402517283098807730L,4615745714708759830L,4343437261816942445L,4499448403339726294L,7937219060315997736L,3519352937229141345L,8932598518390014384L,4367608389437245290L,3381010540120129546L,4586889946474301668L,1268010010247908027L,6717982210732279556L,7302171179731404987L,9146191615103289425L,7702042797875546212L,4026025208899456707L,535690200095803236L,2903027676200584365L,9096144716588008392L,2860562176718226968L,6842571192222302617L,3764157057912949465L,6621650203283181152L,4291859578127470078L,4306242990413860620L,8894580661263156869L,34970916893312221L,1446079611642727357L,4016845347217883880L,6850372643305113260L,3831591323021361906L,6904374412789565791L,8362248313612749768L,3223869809521478785L,3213224429116080193L,3793499541280738449L,4708848800501418045L,5682437838917093525L,3421174366363141103L,7155613070089406669L,3140678417532931613L,5394714865455874948L,1760692646556156626L,4142995098925220580L,7497654512272819365L,2824623351397959167L,5795688788912523710L,747952121084596124L,6783850672070936142L,3400816678237391700L,7723101192044432932L,431517323772707018L,7521438694644272914L,5590516877602472891L,3059386950576194929L,8635923209395653698L,5354821060454402482L,5446914557353608420L,8460153941879572109L,6609018480925361040L,2593971586931117124L,8303826011366573448L,1761800238095287411L,1834175770928893437L,1231047162884343477L,2021915665548722533L,88168652249187853L,848912487625345358L,304821682491051336L,5409519158634696233L,605319405251874758L,2403105156533077533L,5777940628063995724L,7700793133840157772L,5406293558621848109L,3381208482269053672L,6902171288525754349L,3458735407148650115L,8698306172092501356L,8911135970512162267L,8942199292094727744L,6834363456345624152L,474345384748665283L,6043460836674260137L,6567993030684919985L,442262911063773005L,8359465895126847443L,6060069922482834148L,2372782285907905507L,7950346462449519990L,4719457391085243303L,1686861026111605952L,6789808462277987717L,3934179092007767415L,7105078601149402620L,8632230258613372916L,6054688267728669088L,7755875730412685468L,748189482659365259L,465467148831377749L,3877543621174970795L,2847481664702923421L,2279300537986008654L,2700966460360968236L,8194636867662531005L,6073304480163120052L,7206954377320025612L,8914274537983788723L,6426390567703235979L,1539408102470995848L,5203700995469034558L,2357554876620295193L,6149176502497788135L,4582141653405747696L,3791666211017410232L,214936475747502306L,1245223411918588429L,5838135848925218050L,3198746694329978847L,2611960809123301614L,4392968359988055032L,5801771979943199541L,1603808632152869643L,316448185917000880L,77912383708155537L,2086590914520632355L,6416777649380149598L,7548106117183258665L,5799327879947439818L,4674816905486944044L,5400473071735884320L,6117060418361510533L,1791801652173947289L,5460712371260312939L,3589321436084978029L,1453939884862687769L,8878982948709093175L,8247909458499225303L,776012807042647557L,2660019905772732908L,6940076515851127899L,8626991860656260519L,4018031440245180238L,3342587972595895609L,7172530955427398153L,8274122624707350395L,3598458990653620934L,5399083774186507605L,6825418975973623258L,5302330235708588805L,4595788216626793661L,6558437205356397802L,8124030829883114281L,7048989966183189154L,2193230304788237743L,724908531554602701L,2375433012454247365L,7427612007079364628L,1452082311270320676L,9173475250052353156L,1855584535546055003L,7934319185343628488L,5122803212801295768L,7200607767564535887L,418608320831244452L,1182677151678745457L,5860804085001373092L,3028656150871165042L,6753342009922504119L,451793899446224291L,6351340593129734690L,4833833067447665971L,6154161652514572076L,8194878357172601037L,8870217758150378973L,3491623591597982589L,7053846031894724669L,5752543955617596403L,6580414070303114644L,8611070808764662711L,7988184501661551696L,3774593568228068898L,2469184114989682584L,7314470217901559594L,2468962156008128903L,124606222627718776L,718479368998307374L,6503541897294727610L,5148522674989122958L,7954075582626941615L,6245590884365058140L,484822162368841588L,665928517261805491L,2216460214488024118L,4589508002301822687L,5141080200749207037L,7151827035716731481L,6997182637781044647L,882912785835707985L,8164870713031935716L,4493685359826455018L,6563886344838990384L,1737281097690792662L,7371626122116679047L,4303937387441310469L,9187618101141915367L,0L};

#define push_validmb(pos) pos->stack[pos->scnt] = pos->validmb; pos->scnt++;
#define pop_validmb(pos) pos->scnt--; pos->validmb = pos->stack[pos->scnt];

void init_pos(Position *pos, const char *bstr, const char *mbstr, const unsigned int turn, const unsigned int nmove) {
	pos->scnt = 0;
	pos->hcode = 0L;
	pos->nmove = nmove;
	pos->status = 0;
	pos->validmb = pos->p1vics = pos->p2vics = pos->draws = 0;
	for(unsigned int i=0; i<9; i++) {
		pos->p1boards[i] = 0;
		pos->p2boards[i] = 0;
	}

	pos->turn = turn;
    unsigned int mbi, bi;
	for(unsigned int i=0; *bstr!='\0'; bstr++) {
        if(*bstr=='1') {
            imove2mbi(i, &mbi, &bi);
            pos->p1boards[mbi] |= (1<<bi);
            pos->hcode ^= p1hcodes[mbi][bi];
            i++;
        } else if(*bstr=='2') {
            imove2mbi(i, &mbi, &bi);
            pos->p2boards[mbi] |= (1<<bi);
            pos->hcode ^= p2hcodes[mbi][bi];
            i++;
        } else if(*bstr=='0') {
            i++;
        }
	}
	for(unsigned int i=0; *mbstr!='\0'; mbstr++) {
		if(*mbstr=='-') {
			pos->validmb |= (1<<i);
			mbstr++; // skip 1 char
			i++;
		} else if(*mbstr=='0' && is_full(pos->p1boards[i]|pos->p2boards[i])) {
			pos->draws |= (1<<i);
			i++;
		} else if(*mbstr=='1') {
			pos->p1vics |= (1<<i);
			i++;
		} else if(*mbstr=='2') {
			pos->p2vics |= (1<<i);
			i++;
		} else if(*mbstr=='0') {
			i++;
		}
	}
	pos->hcode ^= vbhcodes[pos->validmb];
	if(is_vic(pos->p1vics))
		pos->status = 1;
	else if(is_vic(pos->p2vics))
		pos->status = 2;
	else if(is_full(pos->draws|pos->p1vics|pos->p2vics))
		pos->status = 3;
	else
		pos->status = 0;
}

void make_move(Position *pos, unsigned int m) {
	decode_move(mbi, bi, m)
	push_validmb(pos);
	// make move on boards and update p1vics, p2vics, draws and hash code
	if(pos->turn == 1) {
		pos->p1boards[mbi] |= (1<<bi);
		pos->hcode ^= p1hcodes[mbi][bi];
		if(is_vic(pos->p1boards[mbi]))
			pos->p1vics |= (1<<mbi);
		else if(is_full(pos->p1boards[mbi]|pos->p2boards[mbi]))
			pos->draws |= (1<<mbi);
	} else {
		pos->p2boards[mbi] |= (1<<bi);
		pos->hcode ^= p2hcodes[mbi][bi];
		if(is_vic(pos->p2boards[mbi]))
			pos->p2vics |= (1<<mbi);
		else if(is_full(pos->p1boards[mbi]|pos->p2boards[mbi]))
			pos->draws |= (1<<mbi);
	}
	// update validmb, turn and status
	if(is_vic(pos->p1vics))
		pos->status = 1;
	else if(is_vic(pos->p2vics))
		pos->status = 2;
	else if(is_full(pos->draws|pos->p1vics|pos->p2vics))
		pos->status = 3;
	pos->hcode ^= vbhcodes[pos->validmb];
	if(!isset(pos->draws|pos->p1vics|pos->p2vics,bi))
		pos->validmb = (1<<bi);
	else
		pos->validmb = (~(pos->draws|pos->p1vics|pos->p2vics))&BFULL;
	pos->hcode ^= vbhcodes[pos->validmb];
	pos->turn = opp_turn(pos->turn);
	pos->nmove++;
}

void undo_move(Position *pos, unsigned int m) {
	decode_move(mbi, bi, m)
	// undo move on boards
	if(pos->turn == 2) {
		pos->p1boards[mbi] &= ~(1<<bi);
		pos->hcode ^= p1hcodes[mbi][bi];
		pos->p1vics &= ~(1 << mbi);
		pos->draws &= ~(1 << mbi);
	}
	else {
		pos->p2boards[mbi] &= ~(1<<bi);
		pos->hcode ^= p2hcodes[mbi][bi];
		pos->p2vics &= ~(1 << mbi);
		pos->draws &= ~(1 << mbi);
	}
	pos->turn = opp_turn(pos->turn);
	pos->hcode ^= vbhcodes[pos->validmb];
	pop_validmb(pos);
	pos->hcode ^= vbhcodes[pos->validmb];
	pos->status = 0;
	pos->nmove--;
}

int legal_moves(Position *pos, unsigned int *moves) {
	int nm = 0;
	for(unsigned int mbi=0; mbi<9; mbi++) {
		if(isset(pos->validmb,mbi)) {
			unsigned int board = pos->p1boards[mbi]|pos->p2boards[mbi];
			for(unsigned int bi=0; bi<9; bi++) {
				if(!isset(board,bi)) {
					moves[nm] = code_move(mbi, bi);
					nm++;
				}
			}
		}
	}
	return nm;
}

int victory_moves(Position *pos, unsigned int *moves) {
	int nm = 0;
	const char *vmbs = free_board_moves[~pos->validmb & BFULL];
	for (int vi = 1; vi <= vmbs[0]; vi++) {
		move_type mbi = (move_type)vmbs[vi];
		board_type board = pos->p1boards[mbi] | pos->p2boards[mbi];
		board_type pboard = pos->turn == 1 ? pos->p1boards[mbi] : pos->p2boards[mbi];
		board = (board | ~third_place[pboard]) & BFULL;
		const char *fbs = free_board_moves[board];
		for (int bi = 1; bi <= fbs[0]; bi++) {
			moves[nm] = code_move(mbi, (move_type)fbs[bi]);
			nm++;
		}
	}
	return nm;
}

int flagged_moves(Position *pos, unsigned int *moves, unsigned int *flags) {	
	int nm = 0;
	board_type overs = (pos->p1vics | pos->p2vics | pos->draws);
	const char *vmbs = free_board_moves[~pos->validmb & BFULL];
	for (int vi = 1; vi <= vmbs[0]; vi++) {
		move_type mbi = (move_type)vmbs[vi];
		board_type board = pos->p1boards[mbi] | pos->p2boards[mbi];
		board_type pboard = (pos->turn == 1) ? pos->p1boards[mbi] : pos->p2boards[mbi];
		board_type oboard = (pos->turn == 1) ? pos->p2boards[mbi] : pos->p1boards[mbi];
		const char *fbs = free_board_moves[board];
		for (int i = 1; i <= fbs[0]; i++) {
			move_type bi = fbs[i];
			unsigned int mflags = 0;
			mflags |= (third_place[pboard] & (1 << bi)) ? VICTORY_MOVE : 0;
			mflags |= (!third_place[pboard] && third_place[pboard | (1 << bi)]) ? THREAT_MOVE : 0;
			mflags |= (third_place[oboard] & (1 << bi)) ? TBLOCK_MOVE : 0;
			if ((mflags&VICTORY_MOVE) || (board|(1<<bi)) == BFULL)
				mflags |= ((overs|(1 << mbi))&(1 << bi)) ? OVER_MOVE : 0;
			else
				mflags |= (overs&(1 << bi)) ? OVER_MOVE : 0;
			moves[nm] = code_move(mbi, (move_type)bi);
			flags[nm] = mflags;
			nm++;
		}
	}
	
	/*
	for (unsigned int mbi = 0; mbi<9; mbi++) {
		if (isset(pos->validmb, mbi)) {
			unsigned int board = pos->p1boards[mbi] | pos->p2boards[mbi];
			unsigned int pboard = (pos->turn == 1) ? pos->p1boards[mbi] : pos->p2boards[mbi];
			unsigned int oboard = (pos->turn == 1) ? pos->p2boards[mbi] : pos->p1boards[mbi];
			for (unsigned int bi = 0; bi<9; bi++) {
				if (!isset(board, bi)) {
					int mflags = 0;
					mflags |= (third_place[pboard] & (1<<bi)) ? VICTORY_MOVE : 0;
					mflags |= (!third_place[pboard] && third_place[pboard | (1 << bi)]) ? THREAT_MOVE : 0;
					mflags |= (third_place[oboard] & (1 << bi)) ? TBLOCK_MOVE : 0;
					mflags |= (overs&(1<<bi)) ? OVER_MOVE : 0;
					unsigned int tmove = code_move(mbi, bi);
					int found = 0;
					for (int i = 0; i < nm; i++) {
						if (moves[i] == tmove) {
							found = 1;
							//if (flags[i] != mflags)
							//	printf("flags\n");
						}
					}
					if (!found)
						printf("not found!\n");
				}
			}
		}
	}
	*/
	return nm;
}

void print_pos(Position *pos) {
	for(unsigned int i=0; i<81; i++) {
		if(i%3==0)
			printf(" ");
		if(i%9==0)
			printf("\n");
		if(i%27==0)
			printf("\n");
		unsigned int mbi; unsigned int bi;
		imove2mbi(i, &mbi, &bi);
		if(pos->p1boards[mbi]&(1<<bi))
			printf("1");
		else if(pos->p2boards[mbi]&(1<<bi))
			printf("2");
		else if(pos->p1boards[mbi]&(1<<bi) && pos->p2boards[mbi]&(1<<bi))
			printf("3");
		else
			printf("0");
	}
	printf("\n");
	for(unsigned int i=0; i<9; i++) {
		if(pos->validmb&(1<<i))
			printf("-1,");
		else if(pos->p1vics&(1<<i))
			printf("1,");
		else if(pos->p2vics&(1<<i))
			printf("2,");
		else
			printf("0,");
	}
	printf("\nnmove=%d [p1v=%d p2v=%d drw=%d]\n", pos->nmove, pos->p1vics, pos->p2vics, pos->draws);
}

int mcode2imove(unsigned int m) {
    decode_move(mbi, bi, m)
    return mbi2imove(mbi, bi);
}

unsigned int guess_move(Position *last, Position *current) {
	for (int mbi = 0; mbi < 9; mbi++) {
		if (last->turn == 1 && last->p1boards[mbi] != current->p1boards[mbi]) {
			unsigned int board = last->p1boards[mbi] ^ current->p1boards[mbi];
			for (int bi = 0; bi < 9; bi++) {
				if (board&(1 << bi))
					return code_move(mbi, bi);
			}
		}
		if (last->turn == 2 && last->p2boards[mbi] != current->p2boards[mbi]) {
			unsigned int board = last->p2boards[mbi] ^ current->p2boards[mbi];
			for (int bi = 0; bi < 9; bi++) {
				if (board&(1 << bi))
					return code_move(mbi, bi);
			}
		}
	}
	return NOMOVE;
}

int check_pos(Position *pos) {
	if (pos->turn != 1 && pos->turn != 2)
		return -7;
	if ((pos->draws & pos->p1vics) || (pos->draws & pos->p2vics) || (pos->p2vics & pos->p1vics))
		return -1;
	if ((pos->draws | pos->p1vics | pos->p2vics) & pos->validmb)
		return -2;
	for (int i = 0; i < 9; i++) {
		if (pos->p1boards[i] & pos->p2boards[i])
			return 100 + i;
		if (is_vic(pos->p1boards[i]) && is_vic(pos->p2boards[i]))
			return 200 + i;
		if (is_vic(pos->p1boards[i]) && !(pos->p1vics&(1<<i)))
			return 300 + i;
		if (is_vic(pos->p2boards[i]) && !(pos->p2vics&(1 << i)))
			return 400 + i;
		if (is_full(pos->p1boards[i] | pos->p2boards[i]) && !(pos->draws&(1 << i)))
			return 500 + i;
	}
	return 0;
}




